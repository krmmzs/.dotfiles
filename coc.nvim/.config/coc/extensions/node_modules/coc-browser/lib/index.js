(()=>{"use strict";var e={62:function(e,t,i){var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function u(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,u)}c((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BrowserCompletionProvider=void 0;const o=i(888),s=i(462),u=n(i(622));t.BrowserCompletionProvider=class{constructor(e,t){this.patterns=t,this.sourceDir=e.cacheDir}provideCompletionItems(e,t){const{languageId:i,uri:r}=e,n=this.patterns["*"]||this.patterns[i];if(!n)return[];const s=o.workspace.getDocument(r);if(!s)return[];const u=s.getWordRangeAtPosition(o.Position.create(t.line,t.character-1));if(!u)return[];const c=e.getText(u),a=e.getText(o.Range.create(o.Position.create(t.line,0),t));return!n.length||n.some((e=>new RegExp(e).test(a)))?this.gatherCandidates(c):[]}gatherCandidates(e){return r(this,void 0,void 0,(function*(){const t=yield s.fsReadDir(this.sourceDir);return new Promise(((i,r)=>{Promise.all(t.map((e=>{const t=u.default.join(this.sourceDir,e);return s.fsReadFile(t).then((e=>e.split(/\n/))).catch((e=>r(e)))}))).then((t=>{const r=Array.prototype.concat.apply([],t),n=[...new Set(r)].filter((t=>new RegExp(e).test(t))).map((e=>({label:e,kind:o.CompletionItemKind.Text,insertText:e})));i(n)})).catch((e=>r(e)))}))}))}clearCache(){return r(this,void 0,void 0,(function*(){const e=yield s.fsReadDir(this.sourceDir);for(const t of e){const e=u.default.join(this.sourceDir,t);yield s.fsRmFile(e)}}))}}},151:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Dispose=void 0,t.Dispose=class{constructor(){this.subscriptions=[]}push(e){this.subscriptions.push(e)}dispose(){this.subscriptions.length>0&&(this.subscriptions.forEach((e=>{e.dispose()})),this.subscriptions=[])}}},465:function(e,t,i){var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function u(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,u)}c((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.activate=void 0;const o=i(888),s=i(62),u=i(462),c=n(i(217));t.activate=function(e){return r(this,void 0,void 0,(function*(){const{subscriptions:t,storagePath:i}=e,n=yield u.fsStat(i);(null==n?void 0:n.isDirectory())||(yield u.fsMkdir(i));const a=o.workspace.getConfiguration("browser"),f=new c.default(a.get("port"),i);yield f.start(),t.push(f);const d=new s.BrowserCompletionProvider(f,a.get("patterns"));t.push(o.commands.registerCommand("browser.clearCache",(()=>r(this,void 0,void 0,(function*(){yield d.clearCache()}))))),t.push(o.languages.registerCompletionItemProvider("coc-browser",a.get("shortcut"),null,d,[],a.get("priority"),[]))}))}},217:function(e,t,i){var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function u(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,u)}c((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(i(605)),s=n(i(622)),u=i(888),c=i(462),a=i(151);class f extends a.Dispose{constructor(e,t){super(),this.port=e,this.cacheDir=t,this.counter=0,this.capacity=8}start(){return r(this,void 0,void 0,(function*(){this.server=new o.default.Server,this.server.listen(this.port),this.server.once("error",(()=>{this.server.close()})),this.server.once("listening",(()=>{}));let e="";this.server.on("request",((t,i)=>{t.on("data",(t=>{e+=t})),t.on("end",(()=>r(this,void 0,void 0,(function*(){yield this.saveWords(e),e=""})))),t.on("error",(e=>{u.window.showMessage(`request error from browser: ${e.message}`)})),i.writeHead(200,{"Content-Type":"text/plain"}),i.write("response from coc-browser local server\n"),i.end()}))}))}dispose(){this.server.close((()=>{}))}saveWords(e){return r(this,void 0,void 0,(function*(){const{cacheDir:t}=this,i=s.default.join(t,""+this.counter%this.capacity);yield c.fsWriteFile(i,e),this.counter++}))}}t.default=f},462:function(e,t,i){var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(n,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function u(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,u)}c((r=r.apply(e,t||[])).next())}))},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.fsMkdir=t.fsReadDir=t.fsReadFile=t.fsWriteFile=t.fsRmFile=t.fsStat=void 0;const o=n(i(747));t.fsStat=function(e){return r(this,void 0,void 0,(function*(){return new Promise((t=>{o.default.stat(e,((e,i)=>{e&&t(null),t(i)}))}))}))},t.fsRmFile=function(e){return r(this,void 0,void 0,(function*(){return new Promise(((t,i)=>{o.default.unlink(e,(e=>{e&&i(),t()}))}))}))},t.fsWriteFile=function(e,t){return r(this,void 0,void 0,(function*(){return new Promise(((i,r)=>{o.default.writeFile(e,t,"utf8",(e=>{e&&r(),i()}))}))}))},t.fsReadFile=function(e,t="utf8"){return new Promise(((i,r)=>{o.default.readFile(e,t,((e,t)=>{e&&r(e),i(t)}))}))},t.fsReadDir=function(e){return new Promise(((t,i)=>{o.default.readdir(e,((e,r)=>{e&&i(e),t(r)}))}))},t.fsMkdir=function(e){return new Promise(((t,i)=>{o.default.mkdir(e,(e=>{e&&i(e),t()}))}))}},888:e=>{e.exports=require("coc.nvim")},747:e=>{e.exports=require("fs")},605:e=>{e.exports=require("http")},622:e=>{e.exports=require("path")}},t={},i=function i(r){if(t[r])return t[r].exports;var n=t[r]={exports:{}};return e[r].call(n.exports,n,n.exports,i),n.exports}(465),r=exports;for(var n in i)r[n]=i[n];i.__esModule&&Object.defineProperty(r,"__esModule",{value:!0})})();